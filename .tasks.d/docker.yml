version: '3'

vars:
  COMPOSE_FILE: "{{.REPO_ROOT}}/docker-compose.yml"
  COMPOSE_DEV_FILE: "{{.REPO_ROOT}}/docker-compose.dev.yml"

tasks:
  inject-secrets:
    desc: Generate catalog from template with 1Password secrets
    cmds:
      - |
        TEMPLATE="{{.REPO_ROOT}}/catalogs/airis-catalog.yaml.template"
        OUTPUT="{{.REPO_ROOT}}/catalogs/airis-catalog.yaml"
        if [ ! -f "$TEMPLATE" ]; then
          echo "ERROR: Template not found: $TEMPLATE"
          exit 1
        fi
        DB_PASSWORD=$(op item get sokyzs5sonpdtqbu3urcidv6vm --fields credential --reveal 2>/dev/null)
        if [ -z "$DB_PASSWORD" ]; then
          echo "WARN: 1Password unavailable. Checking existing catalog..."
          if [ -f "$OUTPUT" ]; then
            echo "Using existing catalog (already generated)."
            exit 0
          fi
          echo "ERROR: No catalog and no 1Password. Run 'op signin' first."
          exit 1
        fi
        sed "s|__MINDBASE_DB_PASSWORD__|${DB_PASSWORD}|" "$TEMPLATE" > "$OUTPUT"
        echo "Catalog generated with 1Password secrets."
    silent: true

  up:
    desc: Start the stack (injects secrets from 1Password)
    cmds:
      - task: inject-secrets
      - docker compose -f {{.COMPOSE_FILE}} up -d

  down:
    desc: Stop the stack
    cmds:
      - docker compose -f {{.COMPOSE_FILE}} down

  restart:
    desc: Restart the API container
    cmds:
      - docker compose -f {{.COMPOSE_FILE}} restart api

  ps:
    desc: Show container status
    cmds:
      - docker compose -f {{.COMPOSE_FILE}} ps

  logs:
    desc: Follow API logs
    cmds:
      - docker compose -f {{.COMPOSE_FILE}} logs -f api

  logs:all:
    desc: Follow all container logs
    cmds:
      - docker compose -f {{.COMPOSE_FILE}} logs -f

  logs:tail:
    desc: Show last 50 log lines
    cmds:
      - docker compose -f {{.COMPOSE_FILE}} logs --tail 50 api

  build:
    desc: Build Docker images
    cmds:
      - docker compose -f {{.COMPOSE_FILE}} build

  build:nocache:
    desc: Build Docker images without cache
    cmds:
      - docker compose -f {{.COMPOSE_FILE}} build --no-cache

  pull:
    desc: Pull latest images
    cmds:
      - docker compose -f {{.COMPOSE_FILE}} pull

  clean:
    desc: Stop and remove all containers, volumes
    cmds:
      - docker compose -f {{.COMPOSE_FILE}} down -v

  shell:
    desc: Shell into API container
    cmds:
      - docker compose -f {{.COMPOSE_FILE}} exec api /bin/bash
