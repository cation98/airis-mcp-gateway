# ============================================================
# airis-mcp-gateway Workspace - Monorepo Dev Shell
# ============================================================
# Provides a single container with pnpm/node toolchain for running
# monorepo commands (`just workspace`, `just dev-*`, etc).
# ============================================================

services:
  workspace:
    container_name: airis-mcp-gateway-workspace
    build:
      context: ..
      dockerfile: workspace/Dockerfile.dev
    volumes:
      # ソースコード: :delegated で macOS I/O を最適化
      - ../:/app:delegated
      # 依存・ビルド: named volume で完全隔離（bind mount しない）
      - node_modules:/app/node_modules
      - next_build:/app/.next
      - dist_build:/app/dist
      - build_output:/app/build
      - out_export:/app/out
      - turbo_cache:/app/.turbo
      - swc_cache:/app/.swc
      - cache_dir:/app/.cache
      # NOTE: サブディレクトリのnode_modulesは docker-compose.nm.override.yml で匿名volumeマスク
    working_dir: /app
    expose:
      - "3000"
    environment:
      CHOKIDAR_USEPOLLING: "true"
      CHOKIDAR_INTERVAL: "200"
      WATCHPACK_POLLING: "true"
      NODE_ENV: development
    extra_hosts:
      - "host.docker.internal:host-gateway"
    command: sleep infinity
    networks:
      - default
    labels:
      - "traefik.enable=false"
    develop:
      watch:
        - path: ..
          action: sync
          target: /app
          ignore:
            - node_modules/
            - .next/
            - dist/
            - .turbo/

  measurement:
    container_name: airis-mcp-gateway-measurement
    build:
      context: .
      dockerfile: tools/measurement/Dockerfile
    env_file:
      - ./tools/measurement/.env
    volumes:
      - ./tools/measurement:/app
      - ./libs:/app/libs
      - measurement-node-modules:/app/node_modules
    labels:
      - "traefik.enable=${TRAEFIK_ENABLED:-true}"
      - "traefik.http.routers.measurement.rule=Host(`measurement.localhost`)"
      - "traefik.http.routers.measurement.entrypoints=web"
    networks:
      - traefik

  tests:
    container_name: airis-mcp-gateway-tests
    build:
      context: .
      dockerfile: tests/Dockerfile
    env_file:
      - ./tests/.env
    volumes:
      - ./tests:/app
      - ./libs:/app/libs
      - tests-node-modules:/app/node_modules
    labels:
      - "traefik.enable=${TRAEFIK_ENABLED:-true}"
      - "traefik.http.routers.tests.rule=Host(`tests.localhost`)"
      - "traefik.http.routers.tests.entrypoints=web"
    networks:
      - traefik

  settings:
    container_name: airis-mcp-gateway-settings
    build:
      context: .
      dockerfile: apps/settings/Dockerfile
    env_file:
      - ./apps/settings/.env
    volumes:
      - ./apps/settings:/app
      - ./libs:/app/libs
      - settings-node-modules:/app/node_modules
    labels:
      - "traefik.enable=${TRAEFIK_ENABLED:-true}"
      - "traefik.http.routers.settings.rule=Host(`settings.localhost`)"
      - "traefik.http.routers.settings.entrypoints=web"
    networks:
      - traefik

  menubar:
    container_name: airis-mcp-gateway-menubar
    build:
      context: .
      dockerfile: apps/menubar/Dockerfile
    env_file:
      - ./apps/menubar/.env
    volumes:
      - ./apps/menubar:/app
      - ./libs:/app/libs
      - menubar-node-modules:/app/node_modules
    labels:
      - "traefik.enable=${TRAEFIK_ENABLED:-true}"
      - "traefik.http.routers.menubar.rule=Host(`menubar.localhost`)"
      - "traefik.http.routers.menubar.entrypoints=web"
    networks:
      - traefik

  desktop:
    container_name: airis-mcp-gateway-desktop
    build:
      context: .
      dockerfile: apps/desktop/Dockerfile
    env_file:
      - ./apps/desktop/.env
    volumes:
      - ./apps/desktop:/app
      - ./libs:/app/libs
      - desktop-node-modules:/app/node_modules
    labels:
      - "traefik.enable=${TRAEFIK_ENABLED:-true}"
      - "traefik.http.routers.desktop.rule=Host(`desktop.localhost`)"
      - "traefik.http.routers.desktop.entrypoints=web"
    networks:
      - traefik

  figma:
    container_name: airis-mcp-gateway-figma
    build:
      context: .
      dockerfile: apps/figma/Dockerfile
    env_file:
      - ./apps/figma/.env
    volumes:
      - ./apps/figma:/app
      - ./libs:/app/libs
      - figma-node-modules:/app/node_modules
    labels:
      - "traefik.enable=${TRAEFIK_ENABLED:-true}"
      - "traefik.http.routers.figma.rule=Host(`figma.localhost`)"
      - "traefik.http.routers.figma.entrypoints=web"
    networks:
      - traefik

  api:
    container_name: airis-mcp-gateway-api
    build:
      context: .
      dockerfile: apps/api/Dockerfile
    env_file:
      - ./apps/api/.env
    volumes:
      - ./apps/api:/app
      - ./libs:/app/libs
      - api-node-modules:/app/node_modules
    labels:
      - "traefik.enable=${TRAEFIK_ENABLED:-true}"
      - "traefik.http.routers.api.rule=Host(`api.localhost`)"
      - "traefik.http.routers.api.entrypoints=web"
    networks:
      - traefik

  self-management:
    container_name: airis-mcp-gateway-self-management
    build:
      context: .
      dockerfile: servers/self-management/Dockerfile
    env_file:
      - ./servers/self-management/.env
    volumes:
      - ./servers/self-management:/app
      - ./libs:/app/libs
      - self-management-node-modules:/app/node_modules
    labels:
      - "traefik.enable=${TRAEFIK_ENABLED:-true}"
      - "traefik.http.routers.self-management.rule=Host(`self-management.localhost`)"
      - "traefik.http.routers.self-management.entrypoints=web"
    networks:
      - traefik

  mindbase:
    container_name: airis-mcp-gateway-mindbase
    build:
      context: .
      dockerfile: servers/mindbase/Dockerfile
    env_file:
      - ./servers/mindbase/.env
    volumes:
      - ./servers/mindbase:/app
      - ./libs:/app/libs
      - mindbase-node-modules:/app/node_modules
    labels:
      - "traefik.enable=${TRAEFIK_ENABLED:-true}"
      - "traefik.http.routers.mindbase.rule=Host(`mindbase.localhost`)"
      - "traefik.http.routers.mindbase.entrypoints=web"
    networks:
      - traefik


networks:
  default:
    name: airis-mcp-gateway_default
    external: false

volumes:
  node_modules:   # ルートnode_modules（ホストに出ない）
  next_build:
  dist_build:
  build_output:
  out_export:
  turbo_cache:
  swc_cache:
  cache_dir:
  measurement-node-modules:
  tests-node-modules:
  settings-node-modules:
  menubar-node-modules:
  desktop-node-modules:
  figma-node-modules:
  api-node-modules:
  self-management-node-modules:
  mindbase-node-modules:
