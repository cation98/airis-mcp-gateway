name: CI

on:
  push:
    branches:
      - main
      - next
  pull_request:
    branches:
      - main

jobs:
  # Detect which paths changed
  changes:
    runs-on: ubuntu-latest
    outputs:
      python: ${{ steps.filter.outputs.python }}
      typescript: ${{ steps.filter.outputs.typescript }}
    steps:
      - uses: actions/checkout@v4
      - uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            python:
              - 'apps/api/**'
              - 'pyproject.toml'
            typescript:
              - 'apps/gateway-control/**'
              - 'apps/airis-commands/**'

  # Python tests (only when Python files change)
  test-python:
    needs: changes
    if: needs.changes.outputs.python == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install uv
        uses: astral-sh/setup-uv@v4

      - name: Install dependencies
        run: |
          cd apps/api
          uv pip install --system -e ".[test]"

      - name: Run tests with coverage
        run: |
          cd apps/api
          python -m pytest tests/unit -v --tb=short --cov=src --cov-report=xml --cov-report=term-missing

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v4
        with:
          files: apps/api/coverage.xml
          flags: python
          fail_ci_if_error: false

      - name: Security scan (bandit)
        run: |
          pip install bandit
          bandit -r apps/api/src -ll -ii || true

  # TypeScript build and test (only when TS files change)
  build-typescript:
    needs: changes
    if: needs.changes.outputs.typescript == 'true'
    runs-on: ubuntu-latest
    strategy:
      matrix:
        package: [gateway-control, airis-commands]
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'

      - name: Install dependencies
        run: |
          cd apps/${{ matrix.package }}
          npm install

      - name: Run tests
        run: |
          cd apps/${{ matrix.package }}
          npm test

      - name: Typecheck
        run: |
          cd apps/${{ matrix.package }}
          npx tsc --noEmit

      - name: Build
        run: |
          cd apps/${{ matrix.package }}
          npm run build

  # Auto-merge next to main
  merge-to-main:
    needs: [test-python, build-typescript]
    if: |
      always() &&
      github.ref == 'refs/heads/next' &&
      github.event_name == 'push' &&
      !contains(needs.*.result, 'failure')
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Configure git
        run: |
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"

      - name: Merge next to main
        run: |
          git fetch origin main
          git checkout main
          git merge origin/next --no-edit
          git push origin main

          echo "✅ Merged next → main"
