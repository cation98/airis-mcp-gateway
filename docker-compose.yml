name: airis-mcp-gateway

# IMPORTANT: Use `make init` (or `make up` for advanced use) to start services (auto-sets required environment variables)
# Running `docker compose up` directly will show warnings about unset variables.

services:
  # AIRIS MCP Gateway - すべてのMCPサーバーを統合
  mcp-gateway:
    build:
      context: .
      dockerfile: Dockerfile
      target: gateway
    image: airis-mcp-gateway/gateway:latest
    container_name: airis-mcp-gateway-gateway
    environment:
      - API_URL=${API_INTERNAL_URL:-http://api:${API_LISTEN_PORT:-9900}}
      - GATEWAY_LISTEN_PORT=${GATEWAY_LISTEN_PORT:-9390}
      - PROJECT_ROOT=${CONTAINER_PROJECT_ROOT}
      - HOST_REPO_DIR=${HOST_REPO_DIR}
      - HOST_WORKSPACE_DIR=${HOST_WORKSPACE_DIR}
      - HOST_SUPABASE_DIR=${HOST_SUPABASE_DIR}
      - DOCKER_NETWORK=${DOCKER_NETWORK}
      - COMPOSE_PROJECT_NAME=${COMPOSE_PROJECT_NAME}
      - CONTAINER_PROJECT_ROOT=${CONTAINER_PROJECT_ROOT}
      - CONTAINER_WORKSPACE_ROOT=${CONTAINER_WORKSPACE_ROOT}
    command:
      - /docker-mcp
      - gateway
      - run
      - --transport=sse
      - --port=${GATEWAY_LISTEN_PORT:-9390}
      - --config=/etc/docker-mcp/config.json
      - --servers=filesystem
      - --servers=context7
      - --servers=sequential-thinking
      - --servers=playwright
      - --servers=serena
      - --servers=puppeteer
      - --servers=sqlite
      - --servers=mindbase
      - --servers=self-management
      - --servers=chrome-devtools
    expose:
      - "${GATEWAY_LISTEN_PORT:-9390}"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - type: bind
        source: ${HOST_WORKSPACE_DIR}
        target: ${CONTAINER_WORKSPACE_ROOT}
      - claude-memory:/app/memory
      - ./mcp-config.json:/etc/docker-mcp/config.json:ro
      - ./config/figma-catalog.yaml:/etc/docker-mcp/figma-catalog.yaml:ro
    labels:
      - "x-secret:STRIPE_API_KEY=/run/secrets/stripe_key"
      - "x-secret:TWILIO_ACCOUNT_SID=/run/secrets/twilio_sid"
      - "x-secret:TWILIO_API_KEY=/run/secrets/twilio_key"
      - "x-secret:TWILIO_API_SECRET=/run/secrets/twilio_secret"
      - "x-secret:FIGMA_ACCESS_TOKEN=/run/secrets/figma_token"
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://127.0.0.1:${GATEWAY_LISTEN_PORT:-9390}/"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # Streaming transport for Codex (RMCP streamable_http clients)
  mcp-gateway-stream:
    build:
      context: .
      dockerfile: Dockerfile
      target: gateway
    image: airis-mcp-gateway/gateway:latest
    container_name: airis-mcp-gateway-stream
    environment:
      - API_URL=${API_INTERNAL_URL:-http://api:${API_LISTEN_PORT:-9900}}
      - GATEWAY_LISTEN_PORT=${GATEWAY_STREAM_LISTEN_PORT:-9330}
      - PROJECT_ROOT=${CONTAINER_PROJECT_ROOT}
      - HOST_REPO_DIR=${HOST_REPO_DIR}
      - HOST_WORKSPACE_DIR=${HOST_WORKSPACE_DIR}
      - HOST_SUPABASE_DIR=${HOST_SUPABASE_DIR}
      - DOCKER_NETWORK=${DOCKER_NETWORK}
      - COMPOSE_PROJECT_NAME=${COMPOSE_PROJECT_NAME}
      - CONTAINER_PROJECT_ROOT=${CONTAINER_PROJECT_ROOT}
      - CONTAINER_WORKSPACE_ROOT=${CONTAINER_WORKSPACE_ROOT}
    command:
      - /docker-mcp
      - gateway
      - run
      - --transport=streaming
      - --port=${GATEWAY_STREAM_LISTEN_PORT:-9330}
      - --config=/etc/docker-mcp/config.json
      - --servers=filesystem
      - --servers=context7
      - --servers=sequential-thinking
      - --servers=playwright
      - --servers=serena
      - --servers=puppeteer
      - --servers=sqlite
      - --servers=mindbase
      - --servers=self-management
      - --servers=chrome-devtools
    expose:
      - "${GATEWAY_STREAM_LISTEN_PORT:-9330}"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - type: bind
        source: ${HOST_WORKSPACE_DIR}
        target: ${CONTAINER_WORKSPACE_ROOT}
      - claude-memory:/app/memory
      - ./mcp-config.json:/etc/docker-mcp/config.json:ro
      - ./config/figma-catalog.yaml:/etc/docker-mcp/figma-catalog.yaml:ro
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://127.0.0.1:${GATEWAY_STREAM_LISTEN_PORT:-9330}/mcp"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s


  # PostgreSQL Database (internal only, no port binding)
  postgres:
    image: postgres:17-alpine
    container_name: airis-mcp-gateway-postgres
    environment:
      POSTGRES_USER: ${POSTGRES_USER:-postgres}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-postgres}
      POSTGRES_DB: ${POSTGRES_DB:-mcp_gateway}
    volumes:
      - postgres_data:/var/lib/postgresql/data
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 10s
      timeout: 5s
      retries: 5

  # FastAPI Backend
  api:
    build:
      context: .
      dockerfile: Dockerfile
      target: api
    container_name: airis-mcp-gateway-api
    expose:
      - "${API_LISTEN_PORT:-9900}"
    volumes:
      - type: bind
        source: ${HOST_WORKSPACE_DIR}
        target: ${CONTAINER_WORKSPACE_ROOT}
      - ./apps/api/src:/app/src:rw
      - ./apps/api/alembic:/app/alembic:rw
      - /var/run/docker.sock:/var/run/docker.sock
    environment:
      - DATABASE_URL=postgresql+asyncpg://${POSTGRES_USER:-postgres}:${POSTGRES_PASSWORD:-postgres}@postgres:5432/${POSTGRES_DB:-mcp_gateway}
      - DEBUG=${API_DEBUG:-true}
      - ENCRYPTION_MASTER_KEY=${ENCRYPTION_MASTER_KEY}
      - PROJECT_ROOT=${CONTAINER_PROJECT_ROOT}
      - HOST_REPO_DIR=${HOST_REPO_DIR}
      - HOST_WORKSPACE_DIR=${HOST_WORKSPACE_DIR}
      - HOST_SUPABASE_DIR=${HOST_SUPABASE_DIR}
      - DOCKER_NETWORK=${DOCKER_NETWORK}
      - COMPOSE_PROJECT_NAME=${COMPOSE_PROJECT_NAME}
      - CONTAINER_PROJECT_ROOT=${CONTAINER_PROJECT_ROOT}
      - CONTAINER_WORKSPACE_ROOT=${CONTAINER_WORKSPACE_ROOT}
      - MCP_CONFIG_PATH=${CONTAINER_PROJECT_ROOT}/mcp-config.json
      - API_LISTEN_PORT=${API_LISTEN_PORT:-9900}
    depends_on:
      postgres:
        condition: service_healthy
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://127.0.0.1:${API_LISTEN_PORT:-9900}/health')"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 10s
  # Settings UI - React + Vite frontend
  settings-ui:
    build:
      context: .
      dockerfile: Dockerfile
      target: settings
    container_name: airis-mcp-gateway-settings-ui
    expose:
      - "${UI_CONTAINER_PORT:-5273}"
    environment:
      - UI_PORT=${UI_CONTAINER_PORT:-5273}
      - API_PROXY_URL=${API_INTERNAL_URL:-http://api:${API_LISTEN_PORT:-9900}}
    depends_on:
      - mcp-gateway
      - api
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://127.0.0.1:${UI_CONTAINER_PORT:-5273}/"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
  # Node.js toolchain container for pnpm/node/npm shims
  node:
    image: node:24-bookworm
    container_name: airis-mcp-gateway-node
    working_dir: ${CONTAINER_PROJECT_ROOT}
    profiles:
      - cli
    entrypoint: null
    volumes:
      - type: bind
        source: ${HOST_WORKSPACE_DIR}
        target: ${CONTAINER_WORKSPACE_ROOT}
      - node_modules:${CONTAINER_PROJECT_ROOT}/node_modules
      - pnpm-store:${CONTAINER_PROJECT_ROOT}/.pnpm-store


  # Supabase CLI container routed through bin/supabase shim
  supabase:
    image: ghcr.io/supabase/cli:latest
    container_name: airis-mcp-gateway-supabase
    working_dir: /workspace
    profiles:
      - cli
    volumes:
      - type: bind
        source: ${HOST_WORKSPACE_DIR}
        target: ${CONTAINER_WORKSPACE_ROOT}
      - supabase_data:${CONTAINER_PROJECT_ROOT}/supabase


  # MindBase MCP Server Builder
  # Builds TypeScript → dist/ (read-only artifact for MCP config)
  mindbase-builder:
    build:
      context: .
      dockerfile: Dockerfile
      target: mindbase-builder
    container_name: airis-mcp-gateway-mindbase-builder
    volumes:
      # Source (read-only)
      - ./servers/mindbase/src:/app/src:ro
      - ./servers/mindbase/tsconfig.json:/app/tsconfig.json:ro
      - ./servers/mindbase/package.json:/app/package.json:ro
      - ./servers/mindbase/pnpm-lock.yaml:/app/pnpm-lock.yaml:ro
      # Build output (write to host for MCP Server usage)
      - ./servers/mindbase/dist:/app/dist:rw
      # Dependencies (isolated in Docker)
      - mindbase_node_modules:/app/node_modules
    working_dir: /app
    profiles:
      - builder
    command: >
      sh -c "pnpm install --frozen-lockfile &&
             pnpm build &&
             echo '✅ MindBase MCP Server built: servers/mindbase/dist/' &&
             sleep infinity"

  # Self-Management MCP Server Builder
  self-management-builder:
    build:
      context: .
      dockerfile: Dockerfile
      target: self-management-builder
    container_name: airis-mcp-gateway-self-management-builder
    volumes:
      # Source (read-only)
      - ./servers/self-management/src:/app/src:ro
      - ./servers/self-management/tsconfig.json:/app/tsconfig.json:ro
      - ./servers/self-management/package.json:/app/package.json:ro
      # Build output (write to host for MCP Server usage)
      - ./servers/self-management/dist:/app/dist:rw
      # Dependencies (isolated in Docker)
      - self_management_node_modules:/app/node_modules
    working_dir: /app
    profiles:
      - builder
    command: >
      sh -c "npm install &&
             npm run build &&
             echo '✅ Self-Management MCP Server built: servers/self-management/dist/' &&
             sleep infinity"

  # Test runner - config validation + unit tests
  test:
    image: python:3.12-slim
    working_dir: /workspace
    volumes:
      - .:/workspace:ro
    command: >
      sh -c "python -m venv /tmp/venv &&
             . /tmp/venv/bin/activate &&
             pip install --upgrade pip &&
             pip install -q fastapi sqlalchemy alembic asyncpg aiosqlite pydantic pydantic-settings cryptography python-dotenv pytest pytest-asyncio httpx &&
             PYTHONPATH=/workspace/apps/api/src:/workspace/apps/api pytest tests/test_config.py apps/api/tests/unit/ -v -o addopts=''"
    profiles:
      - test

  # Token Measurement - OpenMCP Pattern validation
  measurement:
    build:
      context: .
      dockerfile: Dockerfile
      target: measurement
    container_name: airis-mcp-gateway-measurement
    volumes:
      - ./apps/api/logs:/app/logs:ro
      - ./metrics:/app/metrics:rw
      - ./docs/research:/app/docs/research:rw
    working_dir: /app
    command: python measure_token_reduction.py
    profiles:
      - measurement

volumes:
  claude-memory:
    driver: local
  postgres_data:
    driver: local
  mindbase_node_modules:
    driver: local
  self_management_node_modules:
    driver: local
  node_modules:
    driver: local
  pnpm-store:
    driver: local
  supabase_data:
    driver: local
