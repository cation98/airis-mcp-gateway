# AIRIS Infrastructure Compose
# Production deployment using GHCR images
#
# Responsibility = Repository = OCI Image
# - airis-mcp-gateway: MCP routing/proxy only
# - airis-agent: PM logic (Confidence, Self-Check, Reflexion, PDCA)
# - mindbase: Long-term memory storage
# - airis-workspace: Toolchain (optional)
#
# Usage:
#   docker compose -f infra/compose.yaml up -d
#   docker compose -f infra/compose.yaml logs -f
#
# Requirements:
#   - GHCR authentication: docker login ghcr.io
#   - Environment variables in .env or shell

name: airis

services:
  # ==========================================================================
  # Database Layer
  # ==========================================================================
  postgres:
    container_name: airis-postgres
    image: pgvector/pgvector:pg16
    environment:
      POSTGRES_USER: ${POSTGRES_USER:-airis}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-airis}
      POSTGRES_DB: ${POSTGRES_DB:-airis}
    volumes:
      - postgres-data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-airis}"]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped

  # ==========================================================================
  # MCP Gateway (Routing Only)
  # ==========================================================================
  # Responsibilities:
  # - MCP server registration and multiplexing
  # - SSE/JSON-RPC transport proxy
  # - Process server management (lazy load, idle kill)
  # - Schema partitioning for token optimization
  # - NO PM logic (Confidence, Self-Check, Reflexion)
  gateway:
    container_name: airis-gateway
    image: ghcr.io/agiletec-inc/airis-mcp-gateway:${GATEWAY_VERSION:-latest}
    ports:
      - "${GATEWAY_PORT:-9400}:8000"
    environment:
      - MCP_GATEWAY_URL=http://mcp-core:9390
      - MCP_CONFIG_PATH=/app/mcp-config.json
      - DATABASE_URL=postgresql://${POSTGRES_USER:-airis}:${POSTGRES_PASSWORD:-airis}@postgres:5432/${POSTGRES_DB:-airis}
    volumes:
      - ./mcp-config.json:/app/mcp-config.json:ro
      - ./profiles:/app/profiles:rw
      - uv-cache:/root/.cache/uv
    depends_on:
      postgres:
        condition: service_healthy
      mcp-core:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:8000/health || exit 1"]
      interval: 10s
      timeout: 3s
      retries: 5
    restart: unless-stopped

  # Docker MCP Gateway Core (internal)
  mcp-core:
    container_name: airis-mcp-core
    image: docker/mcp-gateway:latest
    command:
      - --transport=sse
      - --port=9390
      - --watch
      - --additional-catalog=/catalogs/airis-catalog.yaml
      - --servers=time,mindbase
    expose:
      - "9390"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - ${HOST_WORKSPACE_DIR:-${HOME}/github}:/workspace:rw
      - ./catalogs:/catalogs:ro
    healthcheck:
      test: ["CMD-SHELL", "wget -qS --spider http://localhost:9390/health 2>&1 | grep -q '200'"]
      interval: 10s
      timeout: 3s
      retries: 5
    restart: unless-stopped

  # ==========================================================================
  # AIRIS Agent (PM Logic)
  # ==========================================================================
  # Responsibilities:
  # - ConfidenceChecker (pre-implementation assessment)
  # - SelfCheckProtocol (self-verification)
  # - ReflexionPattern (learning from failures)
  # - 7-Verb Intent Routing (search, summarize, retrieve, plan, edit, execute, record)
  # - PDCA Orchestrator
  # - 30+ slash commands
  #
  # Accessed via MCP tools: airis_do, airis_confidence_check, airis_agent, etc.
  agent:
    container_name: airis-agent
    image: ghcr.io/agiletec-inc/airis-agent:${AGENT_VERSION:-latest}
    profiles: ["full"]  # Only in full deployment
    environment:
      - MINDBASE_URL=http://mindbase:18003
      - DATABASE_URL=postgresql://${POSTGRES_USER:-airis}:${POSTGRES_PASSWORD:-airis}@postgres:5432/${POSTGRES_DB:-airis}
    depends_on:
      postgres:
        condition: service_healthy
    restart: unless-stopped

  # ==========================================================================
  # Mindbase (Long-term Memory)
  # ==========================================================================
  # Responsibilities:
  # - Conversation storage with semantic search
  # - Session management
  # - Memory/knowledge base
  # - Reflexion pattern storage
  # - Graph relationships (entities, relations)
  #
  # Accessed via MCP tools: memory_*, session_*, conversation_*
  mindbase:
    container_name: airis-mindbase
    image: ghcr.io/agiletec-inc/mindbase:${MINDBASE_VERSION:-latest}
    profiles: ["full"]  # Only in full deployment
    environment:
      - DATABASE_URL=postgresql://${POSTGRES_USER:-airis}:${POSTGRES_PASSWORD:-airis}@postgres:5432/${POSTGRES_DB:-airis}
    depends_on:
      postgres:
        condition: service_healthy
    restart: unless-stopped

  # ==========================================================================
  # Optional: Serena (Semantic Code Operations)
  # ==========================================================================
  serena:
    container_name: airis-serena
    image: ghcr.io/oraios/serena:latest
    profiles: ["serena"]
    command:
      - serena
      - start-mcp-server
      - --transport
      - sse
      - --port
      - "8000"
      - --context
      - ide-assistant
    expose:
      - "8000"
    volumes:
      - ${HOST_WORKSPACE_DIR:-${HOME}/github}:/workspaces/projects:rw
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:8000/health 2>/dev/null || exit 0"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    restart: unless-stopped

volumes:
  postgres-data:
  uv-cache:

# ==========================================================================
# Deployment Profiles
# ==========================================================================
#
# Lite (default):
#   docker compose -f infra/compose.yaml up -d
#   - postgres, mcp-core, gateway
#   - Gateway routes to process-based MCP servers (uvx/npx)
#
# Full:
#   docker compose -f infra/compose.yaml --profile full up -d
#   - postgres, mcp-core, gateway, agent, mindbase
#   - All services as Docker containers
#
# With Serena:
#   docker compose -f infra/compose.yaml --profile full --profile serena up -d
#   - Full + Serena for semantic code operations
