# ============================================================
# airis-mcp-gateway - Docker First Monorepo
# ============================================================
# 全ての依存・ビルド生成物は named volume でコンテナ内に閉じ込める
# ホストには node_modules や .next を作らない
# ============================================================

services:
  # ============================================================
  # Workspace - 開発用シェル
  # ============================================================
  workspace:
    container_name: airis-mcp-gateway-workspace
    build:
      context: ../..
      dockerfile: infra/docker/Dockerfile.dev
    volumes:
      # ソースコード: :delegated で macOS I/O を最適化
      - ../..:/app:delegated
      # 依存・ビルド: named volume で完全隔離
      - node_modules:/app/node_modules
      - next_build:/app/.next
      - dist_build:/app/dist
      - build_output:/app/build
      - out_export:/app/out
      - turbo_cache:/app/.turbo
      - swc_cache:/app/.swc
      - cache_dir:/app/.cache
    working_dir: /app
    environment:
      CHOKIDAR_USEPOLLING: "true"
      CHOKIDAR_INTERVAL: "200"
      WATCHPACK_POLLING: "true"
      NODE_ENV: development
    extra_hosts:
      - "host.docker.internal:host-gateway"
    command: sleep infinity
    networks:
      - default
    labels:
      - "traefik.enable=false"

  # ============================================================
  # Apps
  # ============================================================
  api:
    container_name: airis-mcp-gateway-api
    build:
      context: ../..
      dockerfile: apps/api/Dockerfile
    volumes:
      - ../../apps/api:/app
      - ../../libs:/app/libs
      - api-node-modules:/app/node_modules
    labels:
      - "traefik.enable=${TRAEFIK_ENABLED:-true}"
      - "traefik.http.routers.api.rule=Host(`api.mcp-gateway.localhost`)"
      - "traefik.http.routers.api.entrypoints=web"
    networks:
      - coolify

  settings:
    container_name: airis-mcp-gateway-settings
    build:
      context: ../..
      dockerfile: apps/settings/Dockerfile
    volumes:
      - ../../apps/settings:/app
      - ../../libs:/app/libs
      - settings-node-modules:/app/node_modules
    labels:
      - "traefik.enable=${TRAEFIK_ENABLED:-true}"
      - "traefik.http.routers.settings.rule=Host(`settings.mcp-gateway.localhost`)"
      - "traefik.http.routers.settings.entrypoints=web"
    networks:
      - coolify

  gateway-control:
    container_name: airis-mcp-gateway-control
    build:
      context: ../..
      dockerfile: apps/gateway-control/Dockerfile
    volumes:
      - ../../apps/gateway-control:/app
      - ../../libs:/app/libs
      - gateway-control-node-modules:/app/node_modules
    labels:
      - "traefik.enable=${TRAEFIK_ENABLED:-true}"
      - "traefik.http.routers.gateway-control.rule=Host(`control.mcp-gateway.localhost`)"
      - "traefik.http.routers.gateway-control.entrypoints=web"
    networks:
      - coolify

  mindbase:
    container_name: airis-mcp-gateway-mindbase
    build:
      context: ../..
      dockerfile: apps/mindbase/Dockerfile
    volumes:
      - ../../apps/mindbase:/app
      - ../../libs:/app/libs
      - mindbase-node-modules:/app/node_modules
    labels:
      - "traefik.enable=${TRAEFIK_ENABLED:-true}"
      - "traefik.http.routers.mindbase.rule=Host(`mindbase.mcp-gateway.localhost`)"
      - "traefik.http.routers.mindbase.entrypoints=web"
    networks:
      - coolify

  # ============================================================
  # Tools (開発用)
  # ============================================================
  measurement:
    container_name: airis-mcp-gateway-measurement
    build:
      context: ../..
      dockerfile: tools/measurement/Dockerfile
    volumes:
      - ../../tools/measurement:/app
      - ../../libs:/app/libs
      - measurement-node-modules:/app/node_modules
    profiles:
      - tools
    networks:
      - coolify

  tests:
    container_name: airis-mcp-gateway-tests
    build:
      context: ../..
      dockerfile: tests/Dockerfile
    volumes:
      - ../../tests:/app
      - ../../libs:/app/libs
      - tests-node-modules:/app/node_modules
    profiles:
      - tools
    networks:
      - coolify

networks:
  default:
    name: airis-mcp-gateway_default
    external: false
  coolify:
    external: true

volumes:
  # Root
  node_modules:
  next_build:
  dist_build:
  build_output:
  out_export:
  turbo_cache:
  swc_cache:
  cache_dir:
  # Apps
  api-node-modules:
  settings-node-modules:
  gateway-control-node-modules:
  mindbase-node-modules:
  # Tools
  measurement-node-modules:
  tests-node-modules:
