FROM node:24-bookworm

RUN apt-get update && \
    apt-get install -y --no-install-recommends \
      build-essential \
      ca-certificates \
      git \
      curl \
      openssh-client \
      python3 \
      pkg-config \
      tini && \
    rm -rf /var/lib/apt/lists/*

# Enable pnpm via corepack
RUN corepack enable && corepack prepare pnpm@latest --activate

# Ensure dedicated app user exists
RUN set -eux; \
    if ! id -u app >/dev/null 2>&1; then \
      useradd -m -s /bin/bash app; \
    fi; \
    chown -R app:app /home/app

# Pre-create common build directories
RUN mkdir -p /app/{node_modules,.next,dist,build,out,.swc,.cache,.turbo}

WORKDIR /app
# Note: Running as root for dev environment (named volumes require root)

ENTRYPOINT ["tini","--"]
CMD ["sleep","infinity"]
